---
phase: 02-lsp-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/common/packages.nix
  - dotfiles/nvim/lua/plugins/lsp.lua
  - dotfiles/nvim/lua/plugins/completion.lua
  - dotfiles/nvim/lua/plugins/formatting.lua
autonomous: true
requirements: [LSP-01, LSP-02, LSP-03, LSP-04, LSP-05, LSP-06, LSP-07]

must_haves:
  truths:
    - "LSP servers are configured for all 7 target languages (Nix, Python, TS, Go, Rust, C, Lua)"
    - "Autocompletion popup appears on typing with LSP, buffer, and path sources"
    - "Inline diagnostics display as virtual text for errors/warnings with gutter signs"
    - "LSP keymaps (gd, gr, K, <leader>la/lr/lf/ld) bind only in buffers with active LSP"
    - "Format-on-save runs the correct formatter for each configured language"
    - "Lua language server provides Neovim API completions via lazydev.nvim"
    - "pyright, stylua, and rustfmt binaries are available on Nix PATH"
  artifacts:
    - path: "modules/common/packages.nix"
      provides: "pyright, stylua, rustfmt Nix packages"
      contains: "pyright"
    - path: "dotfiles/nvim/lua/plugins/lsp.lua"
      provides: "LSP server configuration, keymaps, diagnostics"
      contains: "vim.lsp.enable"
    - path: "dotfiles/nvim/lua/plugins/completion.lua"
      provides: "blink.cmp + lazydev.nvim completion engine"
      contains: "saghen/blink.cmp"
    - path: "dotfiles/nvim/lua/plugins/formatting.lua"
      provides: "conform.nvim format-on-save"
      contains: "stevearc/conform.nvim"
  key_links:
    - from: "dotfiles/nvim/lua/plugins/lsp.lua"
      to: "dotfiles/nvim/lua/plugins/completion.lua"
      via: "blink.cmp capabilities passed to vim.lsp.config('*')"
      pattern: "require.*blink.cmp.*get_lsp_capabilities"
    - from: "dotfiles/nvim/lua/plugins/completion.lua"
      to: "dotfiles/nvim/lua/plugins/lsp.lua"
      via: "lazydev source provides Neovim API completions to lua_ls"
      pattern: "lazydev.integrations.blink"
    - from: "dotfiles/nvim/lua/plugins/formatting.lua"
      to: "modules/common/packages.nix"
      via: "formatters must be on PATH for conform.nvim to find them"
      pattern: "formatters_by_ft"
---

<objective>
Create all LSP, completion, and formatting plugin configurations for Neovim, plus add missing Nix packages.

Purpose: This is the core of Phase 2 -- configuring 7 LSP servers via the native Neovim 0.11 API, blink.cmp for autocompletion, lazydev.nvim for Neovim API awareness, and conform.nvim for format-on-save. Three missing tool binaries (pyright, stylua, rustfmt) must also be added to the Nix package set.

Output: 3 new plugin files in lua/plugins/ and an updated packages.nix with pyright, stylua, rustfmt.
</objective>

<execution_context>
@/Users/sgoodluck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sgoodluck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lsp-completion/02-CONTEXT.md
@.planning/phases/02-lsp-completion/02-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

<interfaces>
<!-- Existing files the executor needs to understand -->

From dotfiles/nvim/init.lua (thin bootstrap):
- lazy.setup("plugins") auto-scans lua/plugins/ -- new files are picked up automatically
- Leader is space, set before lazy loads
- No changes needed to init.lua

From dotfiles/nvim/lua/config/keymaps.lua (existing keymaps):
- <leader>w, <leader>q, <leader>h already bound
- Window nav (C-h/j/k/l) and indent (<, >) already bound
- LSP keymaps must NOT conflict with these

From modules/common/packages.nix (current package structure):
- Packages grouped by language: Python, Node.js, Go, Rust, Lua/Nix
- pyright, stylua, rustfmt are MISSING and must be added to their respective groups
- python-lsp-server exists inside python3.withPackages but is NOT the chosen Python LSP (pyright is)

From Phase 1 patterns:
- One file per plugin in lua/plugins/, return a lazy.nvim spec table
- lazy.setup("plugins") auto-scans -- no init.lua changes needed
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pyright, stylua, and rustfmt to Nix packages</name>
  <files>modules/common/packages.nix</files>
  <action>
Add three missing packages to modules/common/packages.nix in their correct language groups:

1. **pyright** -- Add `pyright` (Python type checker / LSP) in the Python development section, AFTER the `python3.withPackages` block. Add a comment: `# Python type checker and language server (used by Neovim LSP)`. Do NOT remove `python-lsp-server` from the withPackages block (it doesn't conflict).

2. **stylua** -- Add `stylua` (Lua formatter) in the "Lua and Nix development" section, after `nixd`. Add a comment: `# Lua code formatter (used by conform.nvim)`.

3. **rustfmt** -- Add `rustfmt` (Rust formatter) in the "Rust development" section, after `rust-analyzer`. Add a comment: `# Rust code formatter (used by conform.nvim)`.

Keep existing comments and grouping style. Each package on its own line with a trailing comment.
  </action>
  <verify>
    <automated>grep -c 'pyright\|stylua\|rustfmt' modules/common/packages.nix | grep -q '3' && echo "PASS: all 3 packages found" || echo "FAIL"</automated>
  </verify>
  <done>packages.nix contains pyright, stylua, and rustfmt in their correct language group sections</done>
</task>

<task type="auto">
  <name>Task 2: Create LSP, completion, and formatting plugin files</name>
  <files>dotfiles/nvim/lua/plugins/lsp.lua, dotfiles/nvim/lua/plugins/completion.lua, dotfiles/nvim/lua/plugins/formatting.lua</files>
  <action>
Create three new plugin spec files. Each returns a Lua table for lazy.nvim (matching the one-file-per-plugin pattern from Phase 1).

**File 1: `dotfiles/nvim/lua/plugins/lsp.lua`**

Return a spec for `neovim/nvim-lspconfig` with `dependencies = { "saghen/blink.cmp" }`.

In the `config` function:
- Get capabilities: `local capabilities = require("blink.cmp").get_lsp_capabilities()`
- Set wildcard config: `vim.lsp.config("*", { capabilities = capabilities })`
- Override lua_ls settings:
  ```lua
  vim.lsp.config("lua_ls", {
    settings = {
      Lua = {
        runtime = { version = "LuaJIT" },
        diagnostics = { globals = { "vim" } },
        workspace = { checkThirdParty = false },
        telemetry = { enable = false },
      },
    },
  })
  ```
- Enable all 7 servers: `vim.lsp.enable({ "nixd", "pyright", "ts_ls", "gopls", "rust_analyzer", "ccls", "lua_ls" })`
- Create LspAttach autocmd in group "lsp_keymaps" with these buffer-local keymaps:
  - `gd` -> `vim.lsp.buf.definition` (desc: "Go to definition")
  - `gr` -> `vim.lsp.buf.references` (desc: "References")
  - `K` -> `vim.lsp.buf.hover` (desc: "Hover documentation")
  - `<leader>la` -> `vim.lsp.buf.code_action` (desc: "Code action")
  - `<leader>lr` -> `vim.lsp.buf.rename` (desc: "Rename symbol")
  - `<leader>lf` -> `require("conform").format({ bufnr = buf })` (desc: "Format buffer")
  - `<leader>ld` -> `vim.diagnostic.open_float` (desc: "Line diagnostic")
  - `<leader>lD` -> `vim.diagnostic.setloclist` (desc: "Diagnostic list")
- Configure diagnostics via `vim.diagnostic.config()`:
  - `virtual_text = { severity = { min = vim.diagnostic.severity.WARN }, prefix = "●" }`
  - `signs.text` with nerd font icons: ERROR=" ", WARN=" ", INFO=" ", HINT="󰌵 "
  - `underline = true`, `update_in_insert = false`, `severity_sort = true`

IMPORTANT: Do NOT use `require('lspconfig')` anywhere -- it is deprecated in Neovim 0.11. The nvim-lspconfig plugin is installed only for its `lsp/` directory server definitions which Neovim 0.11 auto-discovers.

**File 2: `dotfiles/nvim/lua/plugins/completion.lua`**

Return a table with TWO specs:

Spec 1: `folke/lazydev.nvim`
- `ft = "lua"` (only loads for Lua files)
- `opts.library` with `{ path = "${3rd}/luv/library", words = { "vim%.uv" } }` for luvit types

Spec 2: `saghen/blink.cmp`
- `version = "1.*"` (prebuilt binary download, safe on macOS/Nix)
- `opts.keymap = { preset = "enter" }` (Enter to accept, per user decision)
- `opts.appearance = { nerd_font_variant = "mono" }`
- `opts.completion.ghost_text = { enabled = false }` (no inline preview per user decision)
- `opts.completion.documentation = { auto_show = true, auto_show_delay_ms = 500 }`
- `opts.sources.default = { "lazydev", "lsp", "path", "buffer" }`
- `opts.sources.providers.lazydev` with `name = "LazyDev"`, `module = "lazydev.integrations.blink"`, `score_offset = 100`
- `opts.fuzzy = { implementation = "prefer_rust_with_warning" }`
- `opts_extend = { "sources.default" }`

**File 3: `dotfiles/nvim/lua/plugins/formatting.lua`**

Return a spec for `stevearc/conform.nvim`:
- `event = { "BufWritePre" }` (lazy-load on save)
- `cmd = { "ConformInfo" }` (make command available)
- `opts.formatters_by_ft`:
  - nix = { "nixfmt" }
  - python = { "black" }
  - typescript = { "prettier" }
  - javascript = { "prettier" }
  - go = { "gofmt" }
  - rust = { "rustfmt" }
  - c = { "clang_format" } (NOTE: underscore, not hyphen)
  - cpp = { "clang_format" }
  - lua = { "stylua" }
- `opts.format_on_save = { timeout_ms = 500, lsp_format = "fallback" }`
- `opts.notify_on_error = false`
- `opts.notify_no_formatters = false` (silent skip per user decision)
  </action>
  <verify>
    <automated>ls dotfiles/nvim/lua/plugins/lsp.lua dotfiles/nvim/lua/plugins/completion.lua dotfiles/nvim/lua/plugins/formatting.lua 2>&1 | grep -c "lua$" | grep -q '3' && echo "PASS: all 3 files exist" || echo "FAIL"</automated>
  </verify>
  <done>Three plugin files exist in lua/plugins/ with correct lazy.nvim spec format: lsp.lua uses vim.lsp.config/enable (not deprecated require('lspconfig')), completion.lua has blink.cmp with enter preset and no ghost text, formatting.lua has conform.nvim with all 9 formatters mapped</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. All 3 new Lua files exist and are syntactically valid:
   ```bash
   nvim --headless -c "luafile dotfiles/nvim/lua/plugins/lsp.lua" -c "q" 2>&1 | grep -i error
   nvim --headless -c "luafile dotfiles/nvim/lua/plugins/completion.lua" -c "q" 2>&1 | grep -i error
   nvim --headless -c "luafile dotfiles/nvim/lua/plugins/formatting.lua" -c "q" 2>&1 | grep -i error
   ```

2. packages.nix contains all 3 new packages:
   ```bash
   grep -E 'pyright|stylua|rustfmt' modules/common/packages.nix
   ```

3. No `require('lspconfig')` call exists (deprecated):
   ```bash
   grep -r "require.*lspconfig" dotfiles/nvim/lua/plugins/ && echo "FAIL: deprecated require found" || echo "PASS"
   ```
</verification>

<success_criteria>
- modules/common/packages.nix has pyright, stylua, and rustfmt added to their correct language sections
- dotfiles/nvim/lua/plugins/lsp.lua configures 7 LSP servers via vim.lsp.config/enable with LspAttach keymaps and diagnostic config
- dotfiles/nvim/lua/plugins/completion.lua configures blink.cmp with enter preset, no ghost text, and lazydev.nvim for Lua files
- dotfiles/nvim/lua/plugins/formatting.lua configures conform.nvim with 9 formatter mappings and silent format-on-save
- No file uses the deprecated require('lspconfig') API
</success_criteria>

<output>
After completion, create `.planning/phases/02-lsp-completion/02-01-SUMMARY.md`
</output>
