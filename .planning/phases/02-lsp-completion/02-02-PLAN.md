---
phase: 02-lsp-completion
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: []
autonomous: false
requirements: [LSP-01, LSP-02, LSP-03, LSP-04, LSP-05, LSP-06, LSP-07]

must_haves:
  truths:
    - "All 7 LSP servers attach to their respective filetypes inside a running Neovim"
    - "Autocompletion popup appears when typing in a Go/Python/Lua file"
    - "Diagnostics show as virtual text and gutter signs for intentional errors"
    - "gd, gr, K, and <leader>l keymaps work in buffers with LSP attached"
    - "Saving a file triggers format-on-save for configured languages"
    - "vim.* completions appear when editing Lua files (lazydev.nvim working)"
    - "pyright, stylua, and rustfmt are on PATH after system rebuild"
  artifacts: []
  key_links:
    - from: "Nix system rebuild"
      to: "modules/common/packages.nix"
      via: "darwin-rebuild switch applies package changes"
      pattern: "nxr"
    - from: "Neovim runtime"
      to: "dotfiles/nvim/lua/plugins/*.lua"
      via: "lazy.nvim auto-scans and loads plugin specs"
      pattern: "lazy.setup"
---

<objective>
Rebuild the Nix system and verify all Phase 2 functionality works end-to-end in a live Neovim session.

Purpose: Plan 01 created config files but they aren't active until a system rebuild installs new packages (pyright, stylua, rustfmt) and Neovim loads the new plugin specs. This plan rebuilds, then verifies the complete LSP + completion + formatting stack.

Output: Verified Phase 2 -- all 7 LSP servers active, completion working, formatting on save.
</objective>

<execution_context>
@/Users/sgoodluck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sgoodluck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lsp-completion/02-CONTEXT.md
@.planning/phases/02-lsp-completion/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild Nix system and verify new packages on PATH</name>
  <files></files>
  <action>
Run the system rebuild to install pyright, stylua, and rustfmt:

```bash
darwin-rebuild switch --flake ~/nix#sgoodluck-m1air
```

After rebuild completes, verify all three new binaries are on PATH:

```bash
which pyright && echo "pyright: OK" || echo "pyright: MISSING"
which stylua && echo "stylua: OK" || echo "stylua: MISSING"
which rustfmt && echo "rustfmt: OK" || echo "rustfmt: MISSING"
```

Also verify the existing LSP servers are still on PATH (regression check):

```bash
which gopls nixd lua-language-server rust-analyzer ccls typescript-language-server
```

If any binary is missing, diagnose the package name in nixpkgs and fix packages.nix.

After PATH verification, open Neovim once to trigger lazy.nvim plugin installation for blink.cmp, conform.nvim, nvim-lspconfig, and lazydev.nvim:

```bash
nvim --headless "+Lazy! sync" +qa
```

This ensures all plugins are downloaded before the human verification step.
  </action>
  <verify>
    <automated>which pyright stylua rustfmt gopls nixd lua-language-server rust-analyzer ccls typescript-language-server 2>&1 | grep -c "/" | grep -q "9" && echo "PASS: all 9 binaries on PATH" || echo "FAIL"</automated>
  </verify>
  <done>System rebuilt, all 9 LSP/formatter binaries on PATH, lazy.nvim plugins synced</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify LSP, completion, and formatting in live Neovim</name>
  <files></files>
  <action>
Human verification of the complete Phase 2 stack in a live Neovim session. Claude creates temporary test files for the user to open:

```bash
echo 'package main\nimport "fmt"\nfunc main() { fmt.Println("hello") }' > /tmp/test.go
echo 'x: int = 1 + "string"' > /tmp/test.py
echo 'const x: number = 42;' > /tmp/test.ts
echo 'int main() { return 0; }' > /tmp/test.c
echo 'fn main() { println!("hello"); }' > /tmp/test.rs
```

Then present the verification checklist to the user.
  </action>
  <verify>
    <automated>echo "CHECKPOINT: requires human verification in live Neovim session"</automated>
  </verify>
  <done>User confirms all 7 LSP servers attach, completion popup works, diagnostics appear, keymaps function, format-on-save runs, and startup time is under 100ms</done>
  <what-built>
Complete LSP + completion + formatting stack: 7 LSP servers configured via vim.lsp.config/enable, blink.cmp autocompletion with LSP/buffer/path sources, conform.nvim format-on-save for 9 language/formatter pairs, and lazydev.nvim for Neovim API completions in Lua files.
  </what-built>
  <how-to-verify>
**LSP attachment (LSP-01, LSP-06):**
1. Open a Go file: `nvim /tmp/test.go` -- type `:LspInfo` and confirm gopls is attached
2. Open a Python file: `nvim /tmp/test.py` -- confirm pyright attaches
3. Open a Nix file: `nvim ~/nix/flake.nix` -- confirm nixd attaches
4. Open a Lua file: `nvim ~/nix/dotfiles/nvim/lua/plugins/lsp.lua` -- confirm lua_ls attaches
5. Quick check the others: open a .ts, .rs, .c file and run `:LspInfo` for each

**Completion (LSP-02, LSP-07):**
6. In the Go file, type `fmt.` and verify the completion popup appears with LSP suggestions
7. In the Lua file, type `vim.` and verify Neovim API completions appear (lazydev.nvim working)
8. Verify Tab/Enter accepts a completion, Escape dismisses
9. Verify NO ghost text appears (only popup menu)

**Diagnostics (LSP-03):**
10. In a Python file, write `x = 1 + "string"` -- verify virtual text warning/error appears inline
11. Verify gutter signs show diagnostic severity icons

**Keymaps (LSP-04):**
12. In a Go file with a function call, put cursor on it and press `gd` -- verify go-to-definition works
13. Press `K` on a symbol -- verify hover documentation appears
14. Press `<leader>la` -- verify code actions menu appears (or shows "no code actions available")

**Format-on-save (LSP-05):**
15. Open a Lua file, add some misformatted code (wrong indentation), save with `:w` -- verify stylua reformats
16. Open a Python file, add unformatted code, save -- verify black reformats
17. Open a Nix file, add unformatted code, save -- verify nixfmt reformats

**Startup time:**
18. Run `nvim --startuptime /tmp/startup.log +q && tail -1 /tmp/startup.log` -- verify still under 100ms (budget allows growth from 34ms baseline)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 2 is complete when ALL of the following are true:
1. `:LspInfo` shows active client for each of: gopls, pyright, ts_ls, nixd, rust_analyzer, ccls, lua_ls
2. Completion popup triggers automatically on typing with LSP suggestions visible
3. `vim.` in a Lua file shows Neovim API completions (lazydev.nvim)
4. Virtual text and gutter signs appear for diagnostic errors/warnings
5. LSP keymaps (gd, gr, K, leader-l*) work in buffers with attached LSP
6. Saving a file auto-formats it (test with at least Lua/Python/Nix)
7. Startup time remains under 100ms
</verification>

<success_criteria>
- System rebuilt with pyright, stylua, rustfmt on PATH
- All 7 LSP servers attach to their respective filetypes
- blink.cmp completion popup works with enter/tab accept, no ghost text
- Diagnostics display inline (virtual text + gutter signs)
- Format-on-save works for all configured languages
- Neovim API completions work in Lua files
- Cold start still under 100ms
</success_criteria>

<output>
After completion, create `.planning/phases/02-lsp-completion/02-02-SUMMARY.md`
</output>
