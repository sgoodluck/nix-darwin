---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/common/packages.nix
autonomous: false
requirements:
  - FNDN-05

must_haves:
  truths:
    - "lua-language-server, nixd, and rust-analyzer are resolvable on PATH inside Neovim"
    - "System rebuilt with updated packages.nix"
  artifacts:
    - path: "modules/common/packages.nix"
      provides: "Missing LSP server packages added"
      contains: "lua-language-server"
  key_links:
    - from: "modules/common/packages.nix"
      to: "Neovim PATH"
      via: "darwin-rebuild switch propagates packages to shell profile"
      pattern: "lua-language-server"
---

<objective>
Add the three missing LSP server packages to packages.nix so they are available on PATH inside Neovim before Phase 2 begins.

Purpose: Nix PATH verification (FNDN-05 prerequisite) requires gopls, lua-language-server, nixd, and rust-analyzer to be visible from inside Neovim. gopls, typescript-language-server, and ccls are already present. This plan adds the three missing ones.
Output: Updated packages.nix with lua-language-server, nixd, and rust-analyzer; system rebuilt.
</objective>

<execution_context>
@/Users/sgoodluck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sgoodluck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@modules/common/packages.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing LSP packages to packages.nix</name>
  <files>modules/common/packages.nix</files>
  <action>
    Add three packages to the `environment.systemPackages` list in the Rust development section. Insert after the `cargo` line (line ~89):

    ```nix
    rust-analyzer          # Rust language server (separate from rustc/cargo)
    ```

    Insert in a new "Lua and Nix development" section after the Rust block:

    ```nix
    # Lua and Nix development
    lua-language-server    # Lua language server (for Neovim config editing)
    nixd                   # Nix language server (nixpkgs-aware, replaces nil)
    ```

    Do NOT add a `lua-language-server` wrapper — use the bare `lua-language-server` nixpkgs package name directly. Confirm nixpkgs 25.05 carries this package (the research confirms `pkgs.lua-language-server` resolves in nixpkgs 25.05).

    Place the additions cleanly within existing groupings:
    - `rust-analyzer` goes after `cargo` in the Rust block
    - `lua-language-server` and `nixd` go after the Rust block, in a new comment group: `# Lua and Nix development`
  </action>
  <verify>
    ```bash
    grep -E "lua-language-server|nixd|rust-analyzer" /Users/sgoodluck/nix/modules/common/packages.nix
    ```
    Must show all three package names. Also verify the file still parses as valid Nix:
    ```bash
    nix-instantiate --parse /Users/sgoodluck/nix/modules/common/packages.nix > /dev/null && echo "valid nix"
    ```
  </verify>
  <done>All three packages appear in packages.nix and the file parses without errors.</done>
</task>

<task type="checkpoint:human-action">
  <name>Task 2: Rebuild system with updated packages</name>
  <files></files>
  <action>Human rebuild required — darwin-rebuild switch must be run by the user since it modifies system state and requires interactive terminal access.</action>
  <what-built>packages.nix now declares lua-language-server, nixd, and rust-analyzer</what-built>
  <how-to-verify>
    Run the system rebuild from your terminal:

    ```bash
    # Personal machine:
    nxr

    # Work machine:
    darwin-rebuild switch --flake ~/nix#Seths-MacBook-Pro
    ```

    The rebuild will take several minutes as Nix downloads and builds the new packages. It is complete when the terminal returns to the shell prompt with no errors.

    After the rebuild completes, verify the packages are on PATH:

    ```bash
    which lua-language-server
    which nixd
    which rust-analyzer
    ```

    All three should return a path (e.g., `/run/current-system/sw/bin/lua-language-server`).
  </how-to-verify>
  <verify>User confirms `which lua-language-server`, `which nixd`, and `which rust-analyzer` all return paths after rebuild.</verify>
  <done>System rebuilt. All three LSP executables are on PATH.</done>
  <resume-signal>Type "rebuilt" once the system rebuild completes and all three `which` checks return paths.</resume-signal>
</task>

</tasks>

<verification>
After plan completion:
- `grep lua-language-server modules/common/packages.nix` returns a match
- `grep nixd modules/common/packages.nix` returns a match
- `grep rust-analyzer modules/common/packages.nix` returns a match
- User has confirmed rebuild succeeded and all three executables are on PATH
</verification>

<success_criteria>
The system has been rebuilt with lua-language-server, nixd, and rust-analyzer available on PATH. The PATH verification diagnostic in Plan 03 will confirm they are visible from inside Neovim.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
