# Codebase Structure

**Analysis Date:** 2026-02-19

## Directory Layout

```
/Users/sgoodluck/nix/
├── flake.nix                    # Flake entry point, inputs, system definitions
├── flake.lock                   # Locked dependencies for reproducibility
├── home.nix                     # User-level configuration (dotfiles, shell, programs)
├── CLAUDE.md                    # Project-level Claude Code instructions
├── README.md                    # Repository overview
├── KEYBINDINGS.md              # Keyboard shortcuts documentation
├── MODERN_CLI_GUIDE.md         # Guide to modern CLI tool replacements
├── .planning/                   # GSD planning directory (created by /gsd commands)
├── darwin/                      # macOS system configuration
│   ├── default.nix             # Module entry point, imports submodules
│   ├── system.nix              # System preferences, fonts, activation scripts
│   ├── packages.nix            # Package management (Nix + Homebrew)
│   └── services.nix            # Launch agents and services
├── hosts/                       # Machine-specific configurations
│   ├── personal/
│   │   └── default.nix         # Personal M1 MacBook Air config
│   └── work/
│       └── default.nix         # Work MacBook Pro config
├── modules/                     # Shared configuration modules
│   └── common/
│       └── packages.nix        # Common packages across all machines
├── dotfiles/                    # Application configuration source files
│   ├── aerospace/
│   │   └── aerospace.toml      # Aerospace window manager config
│   ├── alacritty.toml          # Alacritty terminal emulator config
│   ├── amethyst.yml            # Amethyst window manager config (unused)
│   ├── karabiner.json          # Karabiner keyboard customizer config
│   ├── lazygit.yml             # Lazygit Git UI config
│   ├── zen.toml                # Oh-my-posh prompt theme (Zen)
│   ├── doom/                   # Doom Emacs configuration
│   │   ├── init.el             # Doom module initialization
│   │   ├── config.el           # Custom configuration
│   │   ├── packages.el         # Package declarations
│   │   ├── README.md           # Doom-specific documentation
│   │   ├── .gitignore          # Ignore patterns for Doom
│   │   └── .authinfo.gpg.template  # Template for encrypted credentials
│   ├── nvim/                   # Neovim configuration
│   │   ├── init.lua            # Neovim entry point, lazy.nvim setup
│   │   └── stylua.toml         # Lua formatter config
│   ├── zellij/                 # Zellij terminal multiplexer config
│   │   ├── config.kdl          # Main configuration
│   │   └── layouts/
│   │       └── minimal.kdl     # Minimal layout
│   ├── zed/                    # Zed editor config
│   │   └── settings.json       # Zed settings
│   ├── vscode/                 # VS Code config
│   │   └── settings.json       # VS Code settings
│   ├── claude/                 # Claude Code configurations
│   │   ├── CLAUDE.md           # Claude Code project instructions
│   │   ├── commands/           # Custom Claude Code commands
│   │   │   ├── screenshot.md   # Screenshot capture command
│   │   │   └── pr-review.md    # PR review command
│   │   ├── statusline.sh       # Status line script for Claude
│   │   └── scripts/            # Additional scripts (k8s-db-password)
│   ├── colors/                 # Color scheme files
│   ├── fonts/                  # Font files
│   └── nvim.backup/            # Backup of previous nvim config
├── scripts/                     # Executable scripts
│   ├── doom-git-init.sh        # Initialize git repo for Doom config
│   ├── prompt/                 # Prompt status display scripts
│   │   ├── vpn-status.sh       # VPN connection status
│   │   ├── venv-status.sh      # Python venv status
│   │   ├── aws-profile-status.sh  # AWS profile indicator
│   │   └── kube-status.sh      # Kubernetes context/namespace status
│   └── claude/                 # Claude Code integration scripts
│       ├── screenshot-capture.sh    # Screenshot capture utility
│       └── pr-review.sh            # PR review helper
├── result                       # Symlink to built system (generated by Nix)
└── .git/                        # Git repository metadata
```

## Directory Purposes

**Root Directory:**
- Purpose: Flake definition and top-level configuration
- Contains: flake.nix (Nix Flakes entry point), home.nix (user config), configuration files (README, CLAUDE.md, KEYBINDINGS.md)
- Key files: `flake.nix` (main entry), `home.nix` (user layer), `flake.lock` (dependency lock)

**`darwin/`:**
- Purpose: macOS-specific system configuration (what gets built by nix-darwin)
- Contains: System settings, font packages, Homebrew configuration, launch agents
- Key files: `default.nix` (entry, imports others), `system.nix` (macOS prefs, fonts), `packages.nix` (package setup)

**`hosts/personal/` and `hosts/work/`:**
- Purpose: Per-machine identity and customization
- Contains: Username, email, GPG key, dock apps, machine-specific packages, shell aliases
- Key files: `default.nix` in each (pure data structures)

**`modules/common/`:**
- Purpose: Shared packages and tools used by all machines
- Contains: Development tools (git, neovim, python, nodejs, go, rust), CLI replacements (fd, rg, eza, bat), Kubernetes tools
- Key files: `packages.nix` (single file with all common packages)

**`dotfiles/`:**
- Purpose: Application configuration source of truth (version controlled)
- Contains: Configuration files for 12+ tools (aerospace, alacritty, karabiner, nvim, zed, zellij, etc.)
- Key files: Tool-specific configs (toml, json, lua, el), symlinked via home.nix

**`scripts/`:**
- Purpose: Utility and integration scripts
- Contains: Prompt helpers (vpn, venv, aws, kube status), Claude Code integration, Doom Emacs management
- Key files: Executable bash scripts, sorted by purpose (prompt/, claude/)

## Key File Locations

**Entry Points:**
- `flake.nix`: Flake definition, input pins, Darwin system factory (calls `mkDarwinConfig`)
- `home.nix`: User-level entry point, defines all dotfile symlinks and program configs
- `darwin/default.nix`: Darwin system entry, imports system.nix, packages.nix, services.nix

**Configuration:**
- `hosts/personal/default.nix`: Personal machine identity (username: sgoodluck)
- `hosts/work/default.nix`: Work machine identity (username: seth.martin@firstresonance.io)
- `modules/common/packages.nix`: Shared development environment (100+ packages)
- `.planning/codebase/`: GSD planning documents (ARCHITECTURE.md, STRUCTURE.md, etc.)

**Core Logic:**
- `flake.nix` lines 58-140: `mkDarwinConfig` helper function and module composition
- `home.nix` lines 32-74: Dotfile symlink setup via `home.file`
- `home.nix` lines 142-211: Shell configuration, PATH, aliases, environment variables
- `darwin/system.nix` lines 18-33: Activation scripts (Claude settings initialization)

**Testing:**
- No formal test framework; validation via Nix evaluation (type checking, module conflicts)
- Manual testing: `darwin-rebuild switch --flake ~/nix#<machine>` to build and deploy

## Naming Conventions

**Files:**
- Nix files: `default.nix` (module entry points), kebab-case for descriptive files (e.g., `packages.nix`, `system.nix`)
- Dotfiles: Match tool defaults (e.g., `alacritty.toml`, `karabiner.json`, `init.lua`, `init.el`)
- Scripts: Lowercase with hyphens (e.g., `doom-git-init.sh`, `vpn-status.sh`, `screenshot-capture.sh`)
- Documentation: UPPERCASE.md (e.g., `README.md`, `CLAUDE.md`, `KEYBINDINGS.md`)

**Directories:**
- Machine configs: `hosts/<machine-name>/` (personal, work)
- Feature-based: `modules/<category>/` (common), `scripts/<category>/` (prompt, claude)
- Tool configs: `dotfiles/<tool-name>/` or `dotfiles/<tool-config.format>` (aerospace/, nvim/, doom/, alacritty.toml)

## Where to Add New Code

**New System Setting:**
- Add to: `darwin/system.nix` (if global) or `hosts/*/default.nix` (if machine-specific)
- Pattern: Nix option syntax, follows nix-darwin documentation

**New Development Tool/Package:**
- Add to: `modules/common/packages.nix` (if shared) or `hosts/*/default.nix` (if machine-specific)
- Pattern: List item in `environment.systemPackages` or `homebrew.brews`/`homebrew.casks`

**New Application Configuration:**
- Add to: `dotfiles/<tool>/` or `dotfiles/<tool-name.format>`
- Register in: `home.nix` `home.file` section with symlink pattern
- Example: New nvim plugin → edit `dotfiles/nvim/init.lua`, no home.nix change needed (already symlinked)

**New Shell Alias or Function:**
- Add to: `hosts/*/default.nix` `extraAliases` or `extraShellInit` (machine-specific)
- Or: `home.nix` `programs.zsh.shellAliases` (global)
- Pattern: Bash/Zsh syntax, quote commands properly

**New Prompt Status Indicator:**
- Add to: `scripts/prompt/<name>.sh` (executable script)
- Register in: `dotfiles/zen.toml` (oh-my-posh configuration)
- Symlink: Already handled via `home.nix` `.config/dotfiles/` symlinks

**New Service/Launch Agent:**
- Add to: `darwin/services.nix` under `launchd.user.agents`
- Pattern: Nix attribute set defining `serviceConfig` with `ProgramArguments`, `KeepAlive`, etc.
- Example: Emacs daemon (currently commented out in services.nix, lines 6-19)

**New Script Utility:**
- Add to: `scripts/<category>/<script-name>.sh` (executable)
- Register in: `home.nix` under `home.file` `.local/bin/<name>`
- Pattern: Standard bash/shell syntax, shebang `#!/usr/bin/env bash`

## Special Directories

**`result`:**
- Purpose: Symlink to latest successful Nix build
- Generated: Yes (automatic after `darwin-rebuild switch`)
- Committed: No (symlink, ignored in .gitignore)
- Points to: `/nix/store/<hash>-darwin-system-<version>`

**`.planning/`:**
- Purpose: GSD (Good System Design) command output and planning
- Generated: Yes (created by `/gsd:*` commands)
- Committed: Yes (planning documents are tracked)
- Structure: `codebase/` (analysis docs), `phases/` (implementation plans)

**`dotfiles/nvim.backup/`:**
- Purpose: Previous nvim configuration backup
- Generated: No (manually created)
- Committed: Yes
- Status: Superseded by `dotfiles/nvim/` (using minimal lazy.nvim setup)

## File Path Reference for Implementation

When implementing changes, refer to these paths:

**System Configuration:**
- System-wide settings: `/Users/sgoodluck/nix/darwin/system.nix`
- System packages: `/Users/sgoodluck/nix/modules/common/packages.nix`
- Homebrew casks/brews: `/Users/sgoodluck/nix/hosts/<machine>/default.nix` (extraCasks, extraBrews)
- Services: `/Users/sgoodluck/nix/darwin/services.nix`

**User Configuration:**
- Git, SSH, Zsh: `/Users/sgoodluck/nix/home.nix`
- Aliases/functions: `/Users/sgoodluck/nix/home.nix` (shellAliases, initContent)
- Machine-specific aliases: `/Users/sgoodluck/nix/hosts/<machine>/default.nix` (extraAliases, extraShellInit)

**Application Configs:**
- Alacritty: `/Users/sgoodluck/nix/dotfiles/alacritty.toml`
- Neovim: `/Users/sgoodluck/nix/dotfiles/nvim/init.lua`
- Zed: `/Users/sgoodluck/nix/dotfiles/zed/settings.json`
- Aerospace: `/Users/sgoodluck/nix/dotfiles/aerospace/aerospace.toml`
- Doom Emacs: `/Users/sgoodluck/nix/dotfiles/doom/` (init.el, config.el, packages.el)
- Lazygit: `/Users/sgoodluck/nix/dotfiles/lazygit.yml`
- Zellij: `/Users/sgoodluck/nix/dotfiles/zellij/config.kdl`

**Scripts:**
- Prompt helpers: `/Users/sgoodluck/nix/scripts/prompt/`
- Claude integrations: `/Users/sgoodluck/nix/scripts/claude/`
- Doom management: `/Users/sgoodluck/nix/scripts/doom-git-init.sh`

**Flake/Module Configuration:**
- Flake definition: `/Users/sgoodluck/nix/flake.nix`
- Host configs: `/Users/sgoodluck/nix/hosts/personal/default.nix`, `/Users/sgoodluck/nix/hosts/work/default.nix`
- Darwin modules: `/Users/sgoodluck/nix/darwin/default.nix`, `system.nix`, `packages.nix`, `services.nix`
- Home Manager: `/Users/sgoodluck/nix/home.nix`

---

*Structure analysis: 2026-02-19*
